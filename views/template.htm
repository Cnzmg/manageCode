<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>模板编译</title>
	</head>

	<body>
		<div id="ac"></div>
		<script type="text/javascript">
			let template = `
				<ul>
				  <% for(let i=0; i < data.supplies.length; i++) { %>
				    <li><%= data.supplies[i] %></li>
				  <% } %>
				  
					<% if(data.ace){ %>
						<div><%= data.ace %></div>
					<% } %>
				</ul>
				`;

			function compile(template) {
				const evalExpr = /<%=(.+?)%>/g; //解码
				const expr = /<%([\s\S]+?)%>/g; //解码

				template = template
					.replace(evalExpr, '`); \n  echo( $1 ); \n  echo(`') //echo 
					.replace(expr, '`); \n $1 \n  echo(`'); //expr

				template = 'echo(`' + template + '`);';

				let script =
					`(function parse(data){
			    		let output = "";
			
					    function echo(html){
					      output += html;
					    }
			
			    		${ template }
			
			    	return output;
			  	})`;

				return script;
			}
			var parse = eval(compile(template)),
				ac = document.getElementById('ac');
			ac.innerHTML = parse({
				supplies: ["broom", "mop", "cleaner"],
				ace: 'ace'
			});
		</script>
	</body>

</html>